# Project Context: Vibe Assist

## Overview
A comprehensive code monitoring and security analysis tool that combines a Python AI backend (Daemon), a Next.js web application/API bridge, and a native macOS widget. It provides real-time security vulnerability detection, AI-powered commit analysis, and proactive coding suggestions by monitoring git repositories and screen activity. The system's proactive screen analysis has been simplified to provide a continuous stream of suggestions without deduplication. The system can also perform a one-time, lightweight analysis of a codebase to generate a baseline project context document. The native macOS widget component has been simplified, removing decorative UI elements and auxiliary features like the menu bar launcher to focus on core data display.

## Architecture
Vibe Assist uses a three-tier architecture. The Python Daemon (`apps/daemon`) acts as the core intelligence, running a multi-threaded FastAPI server for git and screen monitoring. It communicates with the Google Gemini API for analysis. A key feature is the on-demand context initialization via an API endpoint. The middle tier, a Next.js application (`apps/web`), provides a web dashboard and an API bridge (`/api/checklist`) for the top tier—the native macOS Widget (`apps/widget`). The overall state management model has been simplified, with the removal of issue management endpoints and the elimination of duplicate-checking for proactive screen analysis, resulting in a more direct 'append-only' stream of AI-generated suggestions.

## Technology Stack
- Python
- FastAPI
- Google Gemini AI
- Next.js
- React
- TypeScript
- Swift
- WidgetKit (macOS)
- Turborepo
- pnpm

## Key Directories
- **apps/daemon**: The core Python backend service responsible for all AI analysis, git monitoring, and screen capture.
- **apps/web**: The Next.js web application that serves as a dashboard and an API bridge between the Python daemon and the macOS widget.
- **apps/widget**: The native macOS widget written in Swift, which displays the final analysis results.
- **apps/docs**: A separate Next.js application for project documentation.
- **packages/ui**: Shared React components used across the Next.js applications.
- **packages/eslint-config**: Shared ESLint configurations for the monorepo.
- **packages/typescript-config**: Shared TypeScript configurations for the monorepo.
- **.vibe-assist**: Stores project-specific data generated by the tool, such as the `context.md` file. This directory should be excluded from version control.

## Project Goals
- Provide real-time security vulnerability detection on uncommitted code changes.
- Analyze new commits for alignment with the project charter.
- Offer proactive coding suggestions by analyzing the developer's screen.
- Expose a clean REST API for integration with frontends and widgets.
- Maintain a simple in-memory state representing the project's health and security status, known as 'Project Cortex'.
- Bridge the backend analysis to a native macOS widget for ambient monitoring.
- Enable AI-powered prompt engineering to assist developers with complex tasks.
- Perform a one-time, lightweight analysis of the codebase to generate a baseline project context document.

## API Endpoints
- **GET /api/checklist**: Exposed by the Next.js app (`apps/web`) for the macOS widget. It fetches state from the Python daemon and transforms it into a widget-friendly checklist format.
- **GET /state**: Exposed by the Python daemon (`apps/daemon`). Returns the current in-memory state of the monitored project, including security score and active issues.
- **GET /health**: Exposed by the Python daemon. A simple health check to verify the service is running and the Gemini client is initialized.
- **POST /oracle/generate_prompt**: Exposed by the Python daemon. An AI prompt engineering endpoint that takes a user's goal and a screenshot to generate an optimized, unstructured text prompt for another AI model.
- **GET /docs**: Exposed by the Python daemon. Serves interactive FastAPI documentation (Swagger UI).
- **POST /context/initialize**: Exposed by the Python daemon. Triggers a lightweight analysis of the codebase to generate a baseline `context.md` file and initialize the project charter in memory.

## Key Functions & Classes
- **main** (`apps/daemon/src/daemon.py`): The main entry point for the Python daemon. It initializes state, starts background threads for watching and screen analysis, and runs the FastAPI server.
- **analyze_fast_path** (`apps/daemon/src/analysis.py`): Performs rapid security analysis on uncommitted git diffs. No longer uses a strict JSON schema for the response.
- **analyze_deep_path** (`apps/daemon/src/analysis.py`): Performs a simplified analysis of a new git commit to check its alignment with the project charter, but no longer updates the charter itself.
- **analyze_screen_proactively** (`apps/daemon/src/analysis.py`): Analyzes a screenshot of the developer's screen using a simplified AI prompt to identify potential coding improvements. It adds all found suggestions to the active issues list without checking for duplicates.
- **initialize_project_context** (`apps/daemon/src/analysis.py`): Performs a one-time, lightweight scan of the codebase using git and file system commands to generate an initial project charter and a `context.md` file.
- **start (watcher)** (`apps/daemon/src/watcher.py`): The main loop in the watcher thread. It continuously checks for uncommitted changes and new commits in the target git repository.
- **start (screen)** (`apps/daemon/src/screen.py`): The main loop in the screen analysis thread. It periodically captures the screen and sends it for proactive analysis.
- **GET (checklist route)** (`apps/web/app/api/checklist/route.ts`): The Next.js API route handler that fetches data from the daemon's `/state` endpoint and formats it for the macOS widget, providing a fallback if the daemon is unavailable.

## Component Interactions
- **macOS Widget** → **Next.js Web App** (API Call): The Swift widget sends a GET request to `/api/checklist` every 15 minutes to refresh its data.
- **Next.js Web App** → **Python Daemon** (API Call): The `/api/checklist` route handler makes a GET request to the daemon's `/state` endpoint to fetch real-time analysis data.
- **Watcher Thread (Daemon)** → **Analysis Module (Daemon)** (Function Call): The watcher thread detects git changes and calls `analysis.analyze_fast_path()` or `analysis.analyze_deep_path()` with the diff content.
- **Screen Thread (Daemon)** → **Analysis Module (Daemon)** (Function Call): The screen thread captures a screenshot and calls `analysis.analyze_screen_proactively()` with the image bytes.
- **Analysis Module (Daemon)** → **Google Gemini API** (External API Call): All analysis functions within the `analysis` module make authenticated requests to the Google Gemini AI API to generate insights.
- **Analysis Module (Daemon)** → **In-Memory State** (State Mutation): Analysis functions acquire a thread lock and update the shared `state` dictionary. Proactive screen analysis now appends suggestions directly without performing duplicate checks.

## Coding Patterns & Conventions
- Monorepo with Shared Packages: Uses Turborepo and pnpm workspaces to manage multiple applications and share code (UI components, configs).
- Multi-threaded Background Tasks: The Python daemon uses threading to run concurrent, non-blocking tasks for git watching and screen analysis.
- In-Memory State Management with Thread Lock: A global dictionary serves as the single source of truth, with a `threading.Lock` to ensure thread-safe updates. Proactive suggestions are appended directly without deduplication, and state is not persisted to disk.
- API Gateway / Bridge Pattern: The Next.js app acts as a bridge, providing a stable, simplified API for the widget while abstracting the more complex backend daemon.
- Simplified AI Interaction without Strict Schemas: Relies on general text or simple JSON responses from the AI model, removing the overhead of strict schema validation frameworks like Pydantic.
- Environment-based Configuration: The application relies on `.env` files and environment variables for configuration, such as API keys and server ports.
- Graceful Fallback: The Next.js API provides a fallback response when the backend daemon is unavailable, ensuring the widget displays a helpful message instead of failing.
- Separation of Source Code and Generated Artifacts: Generated files such as `context.md` and state dumps are stored in the `.vibe-assist` directory, which is intended to be excluded from version control.

## Development Setup
The project is a monorepo managed by pnpm and Turborepo. To set up, run `pnpm install` in the root. For the Python daemon in `apps/daemon`, create and activate a virtual environment, then run `pip install -r requirements.txt`. An essential `GEMINI_API_KEY` environment variable must be set. It is recommended to add the `.vibe-assist/` directory to the project's `.gitignore` file. Start the system with the Python daemon (`python -m src.daemon /path/to/project`) and the Next.js app (`pnpm dev`). The web app runs on port 3000, the daemon on port 8000. To initialize the project context for the first time, send a POST request to `http://localhost:8000/context/initialize`.

---
*Last updated from commit: eca2c454*
*This file is automatically maintained by Vibe Assist.*
